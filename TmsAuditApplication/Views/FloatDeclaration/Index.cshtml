@model VrsAuditApplication.Models.FloatDeclarationViewModel

@{
    ViewData["Title"] = "Float Declaration";
}
<h5 class="mb-4" style="color:blue; text-align:center;">@ViewData["Title"]</h5>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- ✅ Compact Filter Section -->
<div class="w-100 mb-2 shadow-sm bg-light border rounded p-3" style="background-color: lightgrey;">

    <div class="row">
        <!-- Assign Float / Topup Form -->
        <div class="col-md-6 border-end">
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="floatAction" id="assignFloat" value="assign" required />
                <label class="form-check-label fw-bold" for="assignFloat">Assign Float</label>
            </div>

            <div class="mb-2">
                <label class="form-label small">Toll Collector</label>
                <input list="tollCollectors" id="userId" class="form-control form-control-sm" placeholder="-- Select or Type --" required/>
                <datalist id="tollCollectors">
                    @foreach (var userId in Model.ActiveUserIds)
                    {
                        <option value="@userId"></option>
                    }
                </datalist>
            </div>

            <div class="mb-2">
                <label class="form-label small">Operation Day</label><br />
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="currentDay" name="operationDay" value="current" checked />
                    <label class="form-check-label small" for="currentDay">Current Operation Day</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="nextDay" name="operationDay" value="next" />
                    <label class="form-check-label small" for="nextDay">Next Operation Day</label>
                </div>
            </div>

            <div class="mb-2">
                <label class="form-label small">Select Shift</label>
                <select id="shift" class="form-select form-select-sm">
                    <option value="A">-- Select --</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>

            <div class="mb-2">
                <label class="form-label small">Bag Number</label>
                <input type="text" id="bagNumber" class="form-control form-control-sm" required />
            </div>

            <div class="mb-2">
                <label class="form-label small">Amount</label>
                <input type="number" step="0.01" id="amount" class="form-control form-control-sm" required />
            </div>

            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-sm btn-secondary" onclick="InsertFloatAmountTopup()">Add Wim/Topup Amount</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="InsertFloatAmount()">Assign</button>
            </div>
        </div>

        <!-- Cancel Float -->
        <div class="col-md-6">
            <form asp-action="CancelFloat" method="post">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="floatAction" id="cancelFloat" value="cancel" required />
                    <label class="form-check-label fw-bold" for="cancelFloat">Cancel Float</label>
                </div>

                <div class="mb-2">
                    <label class="form-label small">Operation Day</label>
                    <input type="date" id="operationDay" class="form-control form-control-sm"
                           value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>

                <div class="mb-2">
                    <label class="form-label small">User ID</label>
                    <input type="text" name="userId" id="userName" class="form-control form-control-sm" required />
                </div>

                <div class="mb-2">
                    <label class="form-label small">Bag Number</label>
                    <input type="number" name="bagNumber" class="form-control form-control-sm" />
                </div>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-sm btn-info" onclick="loadFloatDetails()">Float Details</button>
                    <button type="submit" class="btn btn-sm btn-danger">Cancel Float</button>
                </div>
            </form>

            <div id="floatDetailsContainer"></div>
        </div>


    </div>
</div>

<div id="SuccessAndErrorMessage"
     style="margin:60px auto 0 auto; max-width:30%; text-align:center;">
</div>

@section Scripts {
    <script>
        function getOperationDay() {
            const today = new Date();
            const baseDate = today.toISOString().split("T")[0]; // yyyy-MM-dd

            if (document.getElementById("nextDay").checked) {
                let tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                return tomorrow.toISOString().split("T")[0];
            }
            return baseDate;
        }

        function InsertFloatAmount() {
            const formData = new FormData();
            formData.append("userId", document.getElementById("userId").value);
            formData.append("bagNumber", document.getElementById("bagNumber").value);
            formData.append("floatAmount", document.getElementById("amount").value); // ✅ match action param name
            formData.append("operationDay", getOperationDay());
            formData.append("shift", document.getElementById("shift").value);

            fetch('@Url.Action("AssignFloat", "FloatDeclaration")', {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(result => {
                const msgDiv = document.getElementById("SuccessAndErrorMessage");
                if (result.success) {
                    msgDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                       // ✅ Clear inputs after success
                        document.getElementById("userId").value = "";
                        document.getElementById("bagNumber").value = "";
                        document.getElementById("amount").value = "";
                        document.getElementById("shift").value = "";
                } else {
                    msgDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                }
            })
            .catch(err => {
                document.getElementById("SuccessAndErrorMessage").innerHTML =
                    `<div class="alert alert-danger">Error occurred: ${err}</div>`;
            });
        }


        function InsertFloatAmountTopup() {
            const formData = new FormData();
            formData.append("userId", document.getElementById("userId").value);
            formData.append("bagNumber", document.getElementById("bagNumber").value);
            formData.append("topupAmount", document.getElementById("amount").value);
            formData.append("operationDay", getOperationDay());
            formData.append("shift", document.getElementById("shift").value);

            fetch('@Url.Action("AddWimTopupFloat", "FloatDeclaration")', {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(result => {
                const msgDiv = document.getElementById("SuccessAndErrorMessage");
                if (result.success) {
                    msgDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                       // ✅ Clear inputs after success
                        document.getElementById("userId").value = "";
                        document.getElementById("bagNumber").value = "";
                        document.getElementById("amount").value = "";
                        document.getElementById("shift").value = "";
                } else {
                    msgDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                }
            })
            .catch(err => {
                document.getElementById("SuccessAndErrorMessage").innerHTML =
                    `<div class="alert alert-danger">Error occurred: ${err}</div>`;
            });
        }

    </script>
}



<script>
    function loadFloatDetails() {
        var operationDay = document.getElementById("operationDay").value;
        var userName = document.getElementById("userName").value;

        $.post("/FloatDeclaration/FloatDetails",
            { operationDay: operationDay, userName: userName },
            function (result) {
                $("#floatDetailsContainer").html(result);
            });
    }
</script>
